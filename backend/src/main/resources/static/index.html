<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>简易在线购物系统</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; margin: 24px; }
    h1 { margin-bottom: 8px; }
    .row { display: flex; gap: 24px; align-items: flex-start; flex-wrap: wrap; }
    .card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; width: 360px; }
    .product { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px dashed #eee; }
    .product:last-child { border-bottom: none; }
    button { padding: 6px 10px; border: 1px solid #d1d5db; background: #f9fafb; border-radius: 6px; cursor: pointer; }
    button:hover { background: #f3f4f6; }
    input { padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 6px; }
    .muted { color: #6b7280; }
  </style>
</head>
<body>
  <div id="app">
    <h1>简易在线购物系统</h1>
    <div class="row">
      <div class="card" style="width: 420px;">
        <h3>用户</h3>
        <div>
          <div>
            <input v-model="username" placeholder="用户名" />
            <input v-model="password" type="password" placeholder="密码" />
            <button @click="register">注册</button>
          </div>
          <div style="margin-top:8px;">
            <input v-model="loginUser" placeholder="用户名" />
            <input v-model="loginPass" type="password" placeholder="密码" />
            <button @click="login">登录</button>
            <div class="muted">当前用户ID：{{ userId || '未登录' }}</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>商品</h3>
        <div v-for="p in products" :key="p.id" class="product">
          <div>
            <div><strong>{{ p.name }}</strong></div>
            <div class="muted">¥{{ p.price }} ｜ 库存 {{ p.stock }}</div>
          </div>
          <div>
            <input type="number" min="1" v-model.number="p._qty" style="width:70px" />
            <button @click="addToCart(p)">加入购物车</button>
          </div>
        </div>
        <div style="margin-top:8px;">
          <input v-model="newProduct.name" placeholder="名称" />
          <input v-model.number="newProduct.price" placeholder="价格" type="number" />
          <input v-model.number="newProduct.stock" placeholder="库存" type="number" />
          <button @click="createProduct">新增商品（示例）</button>
        </div>
      </div>

      <div class="card">
        <h3>购物车</h3>
        <div v-for="ci in cartItems" :key="ci.id" class="product">
          <div>#{{ ci.productId }} × {{ ci.quantity }}</div>
          <div>
            <input type="number" min="1" v-model.number="ci.quantity" style="width:70px" />
            <button @click="updateCartItem(ci)">更新</button>
            <button @click="removeCartItem(ci)">删除</button>
          </div>
        </div>
        <div style="margin-top:8px;">
          <button @click="createOrder">提交订单</button>
          <div class="muted">订单ID：{{ currentOrderId || '-' }}</div>
          <button @click="payOrder" :disabled="!currentOrderId">支付订单</button>
        </div>
      </div>

      <div class="card">
        <h3>我的订单</h3>
        <div v-for="o in orders" :key="o.id" class="product">
          <div>订单 #{{ o.id }}</div>
          <div class="muted">状态：{{ o.status }} ｜ 总额：¥{{ o.totalPrice }}</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { createApp } = Vue;
    const api = axios.create({ baseURL: '/api' }); // 同源，避免跨域
    createApp({
      data() {
        return {
          userId: null,
          username: '', email: '', password: '',
          loginUser: '', loginPass: '',
          products: [],
          cartItems: [],
          orders: [],
          currentOrderId: null,
          newProduct: { name: '', price: 1, stock: 10 },
        }
      },
      mounted() {
        this.refreshProducts();
      },
      methods: {
        async register() {
          await api.post('/users/register', { username: this.username, password: this.password });
          alert('注册成功');
        },
        async login() {
          const r = await api.post('/users/login', { username: this.loginUser, password: this.loginPass });
          if (r.data.success) {
            this.userId = r.data.data.id;
            this.refreshCart();
            this.refreshOrders();
          } else {
            alert(r.data.message || '登录失败');
          }
        },
        async refreshProducts() {
          const r = await api.get('/products');
          this.products = r.data.data.map(p => ({ ...p, _qty: 1 }));
        },
        async createProduct() {
          await api.post('/products', this.newProduct);
          this.newProduct = { name: '', price: 1, stock: 10 };
          this.refreshProducts();
        },
        async addToCart(p) {
          if (!this.userId) return alert('请先登录');
          await api.post(`/cart/${this.userId}/add`, { productId: p.id, quantity: p._qty || 1 });
          this.refreshCart();
        },
        async refreshCart() {
          if (!this.userId) return;
          const r = await api.get(`/cart/${this.userId}`);
          this.cartItems = r.data.data;
        },
        async updateCartItem(ci) {
          await api.put(`/cart/item/${ci.id}`, { quantity: ci.quantity });
          this.refreshCart();
        },
        async removeCartItem(ci) {
          await api.delete(`/cart/item/${ci.id}`);
          this.refreshCart();
        },
        async createOrder() {
          if (!this.userId) return alert('请先登录');
          const r = await api.post('/orders/create', { userId: this.userId });
          this.currentOrderId = r.data.data.id;
          alert('订单创建成功，订单ID：' + this.currentOrderId);
        },
        async payOrder() {
          await api.post('/orders/pay', { orderId: this.currentOrderId, userId: this.userId });
          alert('支付成功');
          this.currentOrderId = null;
          this.refreshProducts();
          this.refreshCart();
          this.refreshOrders();
        },
        async refreshOrders() {
          if (!this.userId) return;
          const r = await api.get(`/orders/my/${this.userId}`);
          this.orders = r.data.data;
        }
      }
    }).mount('#app');
  </script>
</body>
</html>


